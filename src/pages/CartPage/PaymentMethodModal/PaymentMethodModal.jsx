import React, { useState } from 'react';
import './style/PaymentMethodModal.css';

const STATIC_METHODS = [
    { id: 'apple_pay', name: 'Apple Pay', type: 'apple_pay' },
    { id: 'kaspi', name: 'Kaspi.kz', type: 'kaspi' },
];

const PaymentMethodModal = ({
                                isOpen,
                                onClose,
                                selectedMethodId,
                                onSelect,
                                cards = [],
                                onDeleteCard,
                                onAddCard
                            }) => {
    const [cardToDelete, setCardToDelete] = useState(null);

    if (!isOpen) return null;

    const handleDeleteClick = (e, card) => {
        e.stopPropagation();
        setCardToDelete(card);
    };

    const confirmDelete = () => {
        if (cardToDelete) {
            onDeleteCard(cardToDelete.id);
            setCardToDelete(null);
        }
    };

    const cancelDelete = () => {
        setCardToDelete(null);
    };

    const formattedCards = Array.isArray(cards) ? cards.map(card => ({
        id: card.id,
        type: 'card',
        name: `•••• ${card.pan || card.mask || (card.number ? card.number.slice(-4) : '0000')}`,
        system: (card.type || 'visa').toLowerCase()
    })) : [];

    const allMethods = [...STATIC_METHODS, ...formattedCards];

    return (
        <div className="modal-overlay" onClick={onClose}>
            {!cardToDelete && (
                <div className="modal-content payment-modal" onClick={e => e.stopPropagation()}>
                    <div className="modal-header">
                        <h2>Способ оплаты</h2>
                        <button className="close-btn" onClick={onClose}>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6L18 18" stroke="#333" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                        </button>
                    </div>

                    <div className="payment-list">
                        {allMethods.map(method => (
                            <div
                                key={method.id}
                                className="payment-row"
                                onClick={() => onSelect(method.id)}
                            >
                                <div className="payment-left">
                                    <div className={`radio-circle ${selectedMethodId === method.id ? 'active' : ''}`}>
                                        {selectedMethodId === method.id && <div className="radio-dot" />}
                                    </div>
                                    <span className="payment-name">{method.name}</span>
                                    {method.type === 'apple_pay' && <span className=" apple">
                                        <svg width="47" height="30" viewBox="0 0 47 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M42.7906 0H4.20882C4.04805 0 3.88728 0 3.72684 0.00101027C3.5914 0.00202054 3.45596 0.00336757 3.32086 0.0070719C3.026 0.0151541 2.7281 0.0323287 2.43696 0.084526C2.14108 0.137734 1.86548 0.22428 1.59696 0.360667C1.33284 0.494696 1.091 0.66981 0.881257 0.878936C0.671511 1.08806 0.495879 1.32851 0.361452 1.59252C0.224661 1.86058 0.13752 2.13504 0.0848306 2.43038C0.0321408 2.721 0.0145775 3.01734 0.00680914 3.31133C0.00309384 3.44603 0.00174282 3.58107 0.000729551 3.71578C-0.000283714 3.87607 5.40408e-05 4.03637 5.40408e-05 4.19667V25.8033C5.40408e-05 25.964 -0.000283714 26.1239 0.000729551 26.2842C0.00174282 26.4189 0.00309384 26.554 0.00680914 26.6887C0.0149153 26.9823 0.0321408 27.279 0.0848306 27.5693C0.137858 27.8646 0.224661 28.1394 0.361452 28.4071C0.495879 28.6708 0.671511 28.9119 0.881257 29.1207C1.091 29.3302 1.3325 29.5053 1.59696 29.639C1.86581 29.7757 2.14108 29.8623 2.43696 29.9155C2.72844 29.9673 3.02566 29.9852 3.32086 29.9929C3.45596 29.996 3.5914 29.998 3.72684 29.9983C3.88728 29.9997 4.04839 29.9997 4.20882 29.9997H42.7906C42.951 29.9997 43.1121 29.9997 43.2722 29.9983C43.4077 29.9976 43.5428 29.996 43.6785 29.9929C43.9731 29.9848 44.2703 29.9673 44.5625 29.9155C44.858 29.8623 45.1336 29.7757 45.4021 29.639C45.6666 29.5053 45.9077 29.3302 46.1178 29.1207C46.3272 28.9119 46.5029 28.6712 46.6376 28.4071C46.7748 28.1391 46.8616 27.8646 46.9142 27.5693C46.9669 27.2787 46.9842 26.9823 46.9919 26.6887C46.9956 26.554 46.9973 26.4189 46.998 26.2842C46.9994 26.1236 46.9994 25.9636 46.9994 25.8033V4.19667C46.9994 4.03603 46.9994 3.87607 46.998 3.71578C46.9973 3.58107 46.9956 3.44603 46.9919 3.31133C46.9838 3.01734 46.9669 2.721 46.9142 2.43038C46.8616 2.13504 46.7748 1.86025 46.6376 1.59252C46.5029 1.32884 46.3272 1.08806 46.1178 0.878936C45.9077 0.66981 45.6666 0.494696 45.4021 0.360667C45.1333 0.22428 44.858 0.137734 44.5625 0.084526C44.2703 0.0323287 43.9731 0.0148173 43.6785 0.0070719C43.5428 0.00336757 43.4073 0.00202054 43.2722 0.00101027C43.1118 0 42.9507 0 42.7903 0L42.7906 0Z" fill="black"/>
                                            <path d="M42.7881 1.00101L43.2626 1.00202C43.3913 1.00303 43.5197 1.00438 43.649 1.00775C43.874 1.01381 44.1371 1.02593 44.3823 1.06971C44.5954 1.1081 44.7741 1.16636 44.9457 1.25324C45.1149 1.33911 45.2703 1.45159 45.4057 1.58629C45.5418 1.72201 45.6546 1.87725 45.7418 2.04765C45.8286 2.21738 45.8867 2.39485 45.9248 2.60903C45.9687 2.85082 45.9809 3.11382 45.987 3.33945C45.9903 3.46675 45.992 3.59404 45.9927 3.7247C45.9937 3.8823 45.9937 4.03991 45.9937 4.19785V25.8042C45.9937 25.9621 45.9937 26.1194 45.9927 26.2804C45.992 26.4076 45.9903 26.5349 45.987 26.6626C45.9809 26.8879 45.9687 27.1509 45.9241 27.3954C45.8863 27.6065 45.8286 27.784 45.7411 27.9547C45.6543 28.1251 45.5415 28.2797 45.406 28.4147C45.2696 28.5508 45.1152 28.6629 44.9436 28.7495C44.7734 28.836 44.5947 28.8943 44.384 28.932C44.1337 28.9764 43.8598 28.9886 43.6531 28.9943C43.5234 28.9973 43.394 28.999 43.2616 28.9997C43.1039 29.0007 42.9455 29.0007 42.7878 29.0007H4.20597C4.20395 29.0007 4.20192 29.0007 4.19989 29.0007C4.04385 29.0007 3.88747 29.0007 3.72872 28.9997C3.59903 28.999 3.47 28.9973 3.34503 28.9946C3.13394 28.9889 2.85968 28.9768 2.61143 28.9327C2.39864 28.8946 2.21997 28.8363 2.04772 28.7484C1.87783 28.6626 1.72347 28.5504 1.58702 28.4144C1.45192 28.2797 1.33944 28.1254 1.2523 27.9547C1.16516 27.7843 1.10707 27.6062 1.0689 27.3927C1.02466 27.1485 1.0125 26.8865 1.00642 26.6629C1.00304 26.5349 1.00135 26.4066 1.00068 26.2793L1 25.9035V25.8042V4.19751V4.09816L1.00068 3.72302C1.00169 3.59505 1.00304 3.46675 1.00642 3.33878C1.0125 3.11483 1.02466 2.85284 1.06924 2.60667C1.10707 2.39485 1.1655 2.21704 1.25298 2.04563C1.33911 1.87624 1.45192 1.72167 1.58769 1.58629C1.72313 1.45125 1.87816 1.33878 2.04907 1.25223C2.21963 1.16568 2.39864 1.10743 2.61143 1.06904C2.85664 1.02492 3.11975 1.01313 3.34537 1.00674C3.47406 1.00337 3.6024 1.00168 3.73008 1.00101L4.20631 1H42.7881V1.00101Z" fill="white"/>
                                            <path d="M12.831 10.0908C13.2336 9.58908 13.5065 8.91523 13.4346 8.22656C12.8455 8.25586 12.1265 8.61417 11.7103 9.11627C11.3368 9.54631 11.0058 10.2485 11.0919 10.9082C11.7532 10.9654 12.4139 10.5785 12.831 10.0908Z" fill="black"/>
                                            <path d="M13.4235 11.0351C12.4633 10.9781 11.6466 11.5786 11.1879 11.5786C10.7289 11.5786 10.0267 11.064 9.26711 11.0778C8.2785 11.0923 7.36115 11.6496 6.85925 12.536C5.82741 14.3093 6.58702 16.9398 7.59049 18.3838C8.07787 19.0984 8.66523 19.885 9.43902 19.8567C10.1703 19.8281 10.4567 19.3846 11.3457 19.3846C12.2336 19.3846 12.492 19.8567 13.2658 19.8423C14.0683 19.8278 14.5702 19.1273 15.0576 18.4121C15.6166 17.5974 15.8456 16.8111 15.8597 16.768C15.8452 16.7535 14.3122 16.1672 14.298 14.4087C14.2834 12.936 15.5017 12.2359 15.5591 12.1925C14.8711 11.1778 13.7961 11.0633 13.4235 11.0347V11.0351Z" fill="black"/>
                                            <path d="M21.7831 9.04721C23.8705 9.04721 25.3238 10.4818 25.3238 12.5704C25.3238 14.6663 23.8404 16.1083 21.7308 16.1083H19.4195V19.7726H17.75V9.04688H21.7831V9.04721ZM19.4199 14.7111H21.3359C22.7896 14.7111 23.6171 13.9309 23.6171 12.5778C23.6171 11.225 22.7896 10.4522 21.3434 10.4522H19.4199V14.7111Z" fill="black"/>
                                            <path d="M25.7578 17.5512C25.7578 16.1836 26.8089 15.3437 28.673 15.2393L30.8197 15.1131V14.5109C30.8197 13.6411 30.2307 13.1208 29.2468 13.1208C28.3146 13.1208 27.7333 13.5667 27.5918 14.2654H26.0709C26.1604 12.8531 27.3679 11.8125 29.3063 11.8125C31.2072 11.8125 32.4224 12.816 32.4224 14.3843V19.7731H30.8792V18.4874H30.842C30.3874 19.3572 29.3958 19.9071 28.367 19.9071C26.8312 19.9071 25.7578 18.9558 25.7578 17.5512ZM30.8197 16.845V16.2281L28.8888 16.3469C27.9272 16.4139 27.3831 16.8376 27.3831 17.5064C27.3831 18.19 27.9495 18.6362 28.8145 18.6362C29.9402 18.6362 30.8197 17.863 30.8197 16.845Z" fill="black"/>
                                            <path d="M33.8845 22.6495V21.3486C34.0034 21.3783 34.2719 21.3783 34.4064 21.3783C35.1518 21.3783 35.5544 21.0661 35.8003 20.2633C35.8003 20.2485 35.9421 19.7874 35.9421 19.78L33.1094 11.9531H34.8535L36.8368 18.3158H36.8666L38.8499 11.9531H40.5494L37.612 20.1811C36.9412 22.0767 36.1661 22.6859 34.5408 22.6859C34.4067 22.6859 34.0041 22.6711 33.8849 22.6489L33.8845 22.6495Z" fill="black"/>
                                            </svg>
                                    </span>}
                                    {method.type === 'kaspi' && <span className=" kaspi">
                                        <svg width="47" height="30" viewBox="0 0 47 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="0.5" y="0.5" width="46" height="29" rx="1.5" fill="white" stroke="#DBDBDB"/>
                                            <g clipPath="url(#clip0_3853_9315)">
                                            <path fillRule="evenodd" clipRule="evenodd" d="M23.9439 15.6835C25.6443 15.946 25.874 16.9521 26.0114 17.8884L26.0342 18.0481L26.05 18.1568L26.1327 18.7077C26.2948 19.76 26.6327 21.944 26.6327 23.0838C26.6327 23.3685 26.6074 23.5872 26.5618 23.7074C26.4856 23.8926 26.2634 24.0703 25.9564 24.2184C25.2135 24.4012 24.4374 24.5002 23.6377 24.5002C23.5531 24.5002 23.4697 24.4962 23.3859 24.4935C23.0628 24.4017 22.82 24.2485 22.6911 24.0391C22.3028 23.4071 22.2795 21.9987 22.2717 20.3528L22.2709 20.162L22.2676 19.6688C22.255 17.9265 22.2443 16.4245 22.8771 15.8856C23.1224 15.6779 23.4707 15.6092 23.9436 15.6838L23.9439 15.6835ZM20.2366 19.4763C20.6051 19.4557 20.8421 21.268 20.8896 22.6423C20.9231 23.599 20.8225 23.9927 20.662 24.1339C20.4803 24.0732 20.3018 24.0077 20.1261 23.9364C20.0088 23.7233 19.9189 23.3878 19.862 22.9488C19.6884 21.5685 19.8392 19.5008 20.2364 19.4763H20.2366ZM29.4744 22.1847C29.4516 22.3106 29.4189 22.4077 29.3792 22.4899C29.0641 22.7427 28.7329 22.9748 28.3865 23.1836C28.2759 23.2021 28.1779 23.1892 28.1302 23.1082C27.671 22.3012 27.4987 19.7697 27.9431 19.5493C28.5225 19.2697 29.5606 21.747 29.4747 22.1847H29.4744ZM23.5005 5.5C28.6744 5.5 32.8816 9.59718 32.9976 14.6954L33 14.8717V14.9533C32.9906 17.2561 32.1431 19.3631 30.7468 20.994C30.6961 20.9685 30.6037 20.8853 30.4365 20.6352C30.2632 20.3834 28.7697 18.0849 28.7697 15.4503C28.7697 14.9331 29.515 14.1256 30.1743 13.4166C30.6673 12.8831 31.1343 12.3799 31.3063 11.9843C31.5253 11.4739 31.3721 11.1175 31.1297 10.997C30.9102 10.8896 30.5809 10.968 30.3499 11.3783C29.9706 12.0428 29.8491 12.1668 29.2957 12.6115C28.7514 13.0556 27.886 13.503 27.886 12.9241C27.886 12.6115 28.3682 11.9035 28.6063 11.4073C28.8497 10.9057 28.5872 10.5424 28.0851 10.5424C27.0991 10.5424 26.4443 11.7986 26.4443 12.2336C26.4443 12.6684 26.6552 12.7304 26.6552 13.2368C26.6552 13.747 25.5732 14.4088 24.5539 14.4088C23.5727 14.4088 23.0035 14.2102 22.7676 13.6506L22.7376 13.5722L22.6694 13.3704C22.4276 12.6638 22.2542 12.1515 21.9523 11.6158C21.7918 11.3327 21.5447 11.1363 21.3308 10.9637C21.0511 10.7463 20.9059 10.5467 20.8759 10.3975C20.848 10.2496 20.8329 9.97075 21.3109 9.328C21.7878 8.68875 21.8546 8.20622 21.616 7.95691C21.5296 7.86835 21.382 7.81146 21.1926 7.81146C20.8576 7.81146 20.3923 7.98912 19.9124 8.47647C19.1666 9.24078 19.5901 9.96618 19.5901 10.2845C19.5901 10.6028 19.4535 10.7828 19.0062 11.2157C18.5553 11.6505 18.3996 12.0235 18.3481 13.5221C18.3283 14.2942 18.1925 14.7386 18.0704 15.1328C17.9649 15.4782 17.868 15.8029 17.8626 16.2723C17.8543 16.7924 17.9407 17.1273 18.0419 17.514C18.1412 17.8715 18.2464 18.2808 18.3138 18.9659C18.4211 20.0262 18.3838 20.922 18.1887 21.8375L18.1366 22.0669L18.1243 22.1329C18.0843 22.2939 18.0368 22.4893 17.9727 22.5623C15.5678 20.8542 14 18.0653 14 14.9125C14 9.71445 18.2534 5.5 23.5005 5.5Z" fill="#F14635"/>
                                            </g>
                                            <defs>
                                            <clipPath id="clip0_3853_9315">
                                            <rect width="19" height="19" fill="white" transform="translate(14 5.5)"/>
                                            </clipPath>
                                            </defs>
                                        </svg>
                                    </span>}
                                    {method.type === 'card' && (
                                        <div className={`card-icon ${method.system}`}>
                                            {method.system === 'visa' ? 'VISA' : 'MC'}
                                        </div>
                                    )}
                                </div>

                                {method.type === 'card' && (
                                    <button className="delete-card-btn" onClick={(e) => handleDeleteClick(e, method)}>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" strokeWidth="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" strokeLinecap="round" strokeLinejoin="round"/>
                                        </svg>
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>

                    <button className="save-btn" onClick={onClose}>
                        Сохранить
                    </button>

                    <button className="add-card-btn" onClick={onAddCard}>
                        Добавить новую карту
                    </button>
                </div>
            )}

            {cardToDelete && (
                <div className="modal-content confirm-modal" onClick={e => e.stopPropagation()}>
                    <div className="modal-header">
                        <h2>Удаление карты</h2>
                        <button className="close-btn" onClick={cancelDelete}>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6L18 18" stroke="#333" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                        </button>
                    </div>
                    <p className="confirm-text">
                        Вы действительно хотите удалить карту <br/> <b>{cardToDelete.name}</b>?
                    </p>
                    <div className="confirm-actions">
                        <button className="modal-btn primary" onClick={cancelDelete}>Нет</button>
                        <button className="modal-btn secondary-outline" onClick={confirmDelete}>Да, удалить карту</button>
                    </div>
                </div>
            )}
        </div>
    );
};

export default PaymentMethodModal;